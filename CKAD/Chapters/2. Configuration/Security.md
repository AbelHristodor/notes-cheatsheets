---
category: Configuration
Done: 
tags:
  - ckad
  - kubernetes
  - security
  - service-accounts
order: 5
created: 2024-01-21T19:50
updated: 2024-01-22T09:58
---
# SecurityContexts
A security context defines privilege and access control settings for a Pod or Container. Container settings are privileged compared to Pod-level security contexts. By running a pod without a *security context* it will run as *root* user as default.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: security-context-demo
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  containers:
  - name: sec-ctx-demo
    image: busybox:1.28
    command: [ "sh", "-c", "sleep 1h" ]
    securityContext:
	  capabilities:
		  add: ["MAC_ADMIN"] # Add other capabilities here -- linux -- only supported at container-level
      allowPrivilegeEscalation: false
```

# ServiceAccounts
A service account is an account that can be used by an application/external software to interact with the cluster while having specific permissions. It is like a `user` account but for machines/softwares.

To create one: `k create serviceaccount <name>` 
Once created, the service account comes with a *token* that must be used by the external app while authenticating with the cluster. The token is stored as a secret object linked to the `service account`. To view  it use the `k describe secret <secret>` command.

The token can be decoded with a jwt decoder and you'll find some cluster info in the payload. One important thing is that the JWT token is not `time-bounded` i.e. do not expire.
When a namespace gets created, a *service account* automatically gets created and its token mounted to every pod running into that namespace as a volume mount.

The **default** service account is very limited, so, to add more permissions you need to change your pod's service account.

You can prevent kubernetes to auto-mount the default service account by setting the `automountServiceAccountToken: false` field. 

**NOTE - 1.22**
As of version 1.22 of k8s, the **TokenRequestAPI** was introduce to generate *audience-bound, time-bound, object-bound* tokens, thus making them much more secure. So, from 1.22 onwards pods no longer rely on the service account token, instead a token with a defined lifetime gets generated by the **TokenRequestAPI** and then gets mounted as a projected volume onto the pod.

**NOTE - 1.24**
As of 1.24 of k8s, the creation of a service account **does not** automatically provision a secret token but you can generate it with `k create token <my_service_account>` to generate a token using the **TokenRequestAPI**. This token now has an *expiry date* (1  hour) and you can save it as a secret.
You can still create a token and link it to a service account like the old way, but you first need to create the service account and then a secret:
```yaml
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: my_secret_name
  annotations:
    kubernetes.io/service-account.name: my_service_account
```

This will create a non-expiring token and link it to the sa. This is **not recommended** since not secure, you should use this way only if you cannot use the **TokenRequestAPI**