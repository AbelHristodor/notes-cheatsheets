---
created: 2024-03-10T10:43
updated: 2024-03-10T11:15
tags:
  - istio
category: Management
---
<small> Note: these notes are all taken from the official <a href="https://istio.io/latest/docs/concepts/traffic-management/"> Istio documentation</a></small>

<hr>
# General
Istio lets you set up traffic rules to **control** the **flow of traffic** and API calls between services.
Traffic management model relies on the *Envoy* proxies deployed on your services since all traffic that your mesh services send and receive is *proxied* through Envoy.

## Introduction
First of all, Istio needs to discover all you endpoints and which services they belong to, so, in order to populate its *service registry*, Istio connects to a **service discovery system.**  
Thanks to this service registry *Envoy* proxies can direct traffic to relevant services, using by default a **least request model** i.e. sends the requests to the service with the *fewer active requests*, so the most heavily loaded hosts will not receive requests until it is no more loaded than any other host. 

Like other Istio configuration, the API is specified using Kubernetes custom resource definitions (CRDs), which you can configure using YAML.

The resources the Istio API exposes are the following:
- [[#Virtual Services]]
- [[#Destination Rules]]
- [[#Gateways]]
- [[#Service Entries]]
- [[#Sidecars]]

## Virtual Services
Lets you configure *how requests are routed to a service* within an Istio service mesh. Each VS consists of a **set of routing rules** evaluated in order, letting istio match each request to the VS to a specific real destination within the mesh. You can have *none to many*, depending on your use-case.

### Why?
**Without virtual services**, Envoy distributes traffic using *least requests load balancing* between all service instances, as described in the introduction. 

**With a virtual service**, you can specify traffic behavior for one or more hostnames. You use routing rules in the virtual service that tell Envoy how to send the virtual service’s traffic to appropriate destinations. *Route destinations can be different versions of the same service or entirely different services*.

A typical **use case** is to send traffic to different versions of a service, specified as service subsets. Clients send requests to the virtual service host *as if it was a single entity*, and Envoy then *routes* the traffic to the *different versions* depending on the virtual service *rules*: for example, “20% of calls go to the new version” or “calls from these users go to version 2”. This **allows** you to, for instance, create a **canary rollout** where you gradually increase the percentage of traffic that’s sent to a new service version. **The traffic routing is completely separate from the instance deployment**, meaning that the number of instances implementing the new service version can scale up and down based on traffic load without referring to traffic routing at all.

### Example
The following virtual service routes requests to different versions of a service depending on whether the request comes from a particular user.
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v3
```

#### The hosts field
The `hosts` field lists the virtual service’s hosts - in other words, the user-addressable destination or **destinations** that these routing rules apply to i.e.  **the address the client uses when sending requests to the service**.
Can be an **IP**, **DNS name**, or a short name (e.g. Kubernetes service name) that resolves to a **FQDN**. Wildcard prefixes are allowed.
#### Routing rules
The `http` section contains the virtual service’s routing rules, describing **match conditions and actions** for routing `HTTP/1.1`, `HTTP2`, and `gRPC` traffic sent to the destination(s) specified in the hosts field (you can also use `tcp` and `tls` sections to configure routing rules for **TCP** and **unterminated TLS** traffic).

**Match**
In  this case you want this routing to apply to all requests from the user *jason*, so you use the headers, end-user, and exact fields to select the appropriate requests.

```yaml
- match:
   - headers:
       end-user:
         exact: jason
```

**Destination**
Specifies the actual destination for traffic that matches this condition.
Unlike the virtual service’s host(s), the destination’s host **must** be a **real destination** that exists in Istio’s **service registry** or Envoy won’t know where to send traffic to it.
In this case we’re running on Kubernetes and the host name is a Kubernetes service name and the subset `v2` (check [[#Destination Rules]]).

```yaml
route:
- destination:
    host: reviews
    subset: v2

```

**Routing rules are evaluated in sequential order from top to bottom**
#### Other examples
This virtual service lets users send traffic to *two separate services*, ratings and reviews, as if they were part of a bigger virtual service at `http://bookinfo.com/.` The virtual service rules *match* *traffic* based on request *URIs* and direct requests to the appropriate service.

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
    - bookinfo.com
  http:
  - match:
    - uri:
        prefix: /reviews
    route:
    - destination:
        host: reviews
  - match:
    - uri:
        prefix: /ratings
    route:
    - destination:
        host: ratings

```

You can add **multiple match conditions** to the same `match` block to **AND** your conditions, or add **multiple match blocks** to the same `rule` to **OR** your conditions. You can also have multiple routing rules for any given virtual service.  Check [`HTTPMatchRequest` reference](https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest).

In addition to using match conditions, you can distribute traffic by percentage `weight`. This is useful for A/B testing and canary rollouts:
```yaml
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 75
    - destination:
        host: reviews
        subset: v2
      weight: 25
```
Check the [`HTTPRoute` reference](https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute) to learn about more routing actions (URL rewrite, retry policy and headers append/remove).

## Destination Rules

## Gateways

## Service Entries

## Sidecars